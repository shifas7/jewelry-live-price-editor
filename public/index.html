<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Gold Price Editor - Bhima Jewellery</title>

    <!-- Shopify App Bridge (for embedded apps) -->
    <script src="https://unpkg.com/@shopify/app-bridge@3"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f6f6f7;
        color: #202223;
      }

      .app-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        width: 32px;
        height: 32px;
        background: #ffa500;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 1px solid #e1e3e5;
      }

      .tab {
        padding: 12px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #6d7175;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab:hover {
        color: #202223;
      }

      .tab.active {
        color: #202223;
        border-bottom-color: #000;
      }

      .card {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        margin-bottom: 24px;
      }

      .card h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 6px;
        color: #202223;
      }

      .form-group input,
      .form-group select {
        padding: 10px 12px;
        border: 1px solid #c9cccf;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #005bd3;
        box-shadow: 0 0 0 3px rgba(0, 91, 211, 0.1);
      }

      .input-suffix {
        position: relative;
      }

      .input-suffix input {
        padding-right: 40px;
      }

      .input-suffix::after {
        content: attr(data-suffix);
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6d7175;
        font-size: 13px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #000;
        color: white;
      }

      .btn-primary:hover {
        background: #2c2c2c;
      }

      .btn-secondary {
        background: white;
        color: #202223;
        border: 1px solid #c9cccf;
      }

      .btn-secondary:hover {
        background: #f6f6f7;
      }

      .btn-icon {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .product-table {
        width: 100%;
        border-collapse: collapse;
      }

      .product-table th {
        text-align: left;
        padding: 12px;
        background: #f6f6f7;
        font-weight: 600;
        font-size: 13px;
        border-bottom: 1px solid #e1e3e5;
      }

      .product-table td {
        padding: 12px;
        border-bottom: 1px solid #f1f1f1;
        font-size: 14px;
      }

      .product-table tr:hover {
        background: #f9f9f9;
      }

      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge-success {
        background: #d4edda;
        color: #155724;
      }

      .badge-pending {
        background: #fff3cd;
        color: #856404;
      }

      .badge-active {
        background: #d4edda;
        color: #155724;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 24px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-header h2 {
        font-size: 20px;
        font-weight: 600;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6d7175;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #6d7175;
      }

      .stone-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .stone-table th,
      .stone-table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #e1e3e5;
      }

      .stone-table th {
        background: #f6f6f7;
        font-weight: 600;
      }

      .calculation-result {
        background: #f6f6f7;
        padding: 16px;
        border-radius: 6px;
        margin-top: 16px;
      }

      .calculation-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        font-size: 14px;
      }

      .calculation-row.total {
        border-top: 2px solid #000;
        margin-top: 8px;
        padding-top: 12px;
        font-weight: 600;
        font-size: 16px;
      }

      .link-button {
        background: none;
        border: none;
        color: #005bd3;
        cursor: pointer;
        text-decoration: underline;
        font-size: 14px;
      }

      .link-button:hover {
        color: #004085;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // API Base URL - automatically detects localhost vs deployed
      const API_BASE =
        window.location.hostname === "localhost"
          ? "http://localhost:3010/api"
          : `${window.location.protocol}//${window.location.host}/api`;

      console.log("API Base URL:", API_BASE);

      function App() {
        const [activeTab, setActiveTab] = useState("dashboard");
        const [metalPrices, setMetalPrices] = useState({
          gold24kt: "",
          gold22kt: "",
          gold18kt: "",
          gold14kt: "",
          platinum: "",
          silver: "",
        });
        const [showSuccess, setShowSuccess] = useState(false);
        const [products, setProducts] = useState([]);
        const [selectedProduct, setSelectedProduct] = useState(null);
        const [loading, setLoading] = useState(false);
        const [stonePrices, setStonePrices] = useState([]);
        const [showStoneModal, setShowStoneModal] = useState(false);
        const [selectedStone, setSelectedStone] = useState(null);

        // Load metal prices on mount
        useEffect(() => {
          loadMetalPrices();
          loadProducts();
          loadStonePrices();
        }, []);

        const loadMetalPrices = async () => {
          try {
            const response = await fetch(`${API_BASE}/metal-prices`);
            const data = await response.json();
            if (data.success) {
              setMetalPrices(data.data);
            }
          } catch (error) {
            console.error("Error loading metal prices:", error);
          }
        };

        const loadProducts = async () => {
          try {
            setLoading(true);
            const response = await fetch(`${API_BASE}/products`);
            const data = await response.json();
            if (data.success) {
              setProducts(data.data);
            }
          } catch (error) {
            console.error("Error loading products:", error);
          } finally {
            setLoading(false);
          }
        };

        const loadStonePrices = async () => {
          try {
            const response = await fetch(`${API_BASE}/stone-prices`);
            const data = await response.json();
            if (data.success) {
              setStonePrices(data.data);
            }
          } catch (error) {
            console.error("Error loading stone prices:", error);
          }
        };

        const handleMetalPriceChange = (key, value) => {
          setMetalPrices((prev) => ({
            ...prev,
            [key]: value,
          }));
        };

        const handleUpdateMetalPrices = async () => {
          try {
            setLoading(true);
            const response = await fetch(`${API_BASE}/metal-prices`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(metalPrices),
            });

            const data = await response.json();
            if (data.success) {
              setShowSuccess(true);
              setTimeout(() => setShowSuccess(false), 3000);
            }
          } catch (error) {
            console.error("Error updating metal prices:", error);
            alert("Error updating prices");
          } finally {
            setLoading(false);
          }
        };

        const handleRefreshPrices = async () => {
          if (
            !confirm(
              "This will update all product prices based on current metal rates. Continue?"
            )
          ) {
            return;
          }

          try {
            setLoading(true);
            const response = await fetch(`${API_BASE}/refresh-prices`, {
              method: "POST",
            });

            const data = await response.json();
            if (data.success) {
              alert(data.message);
              loadProducts();
            }
          } catch (error) {
            console.error("Error refreshing prices:", error);
            alert("Error refreshing prices");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="app-container">
            <div className="header">
              <h1>
                <div className="logo">L</div>
                Live Gold Price Editor
              </h1>
            </div>

            <div className="tabs">
              <button
                className={`tab ${activeTab === "dashboard" ? "active" : ""}`}
                onClick={() => setActiveTab("dashboard")}
              >
                Dashboard
              </button>
              <button
                className={`tab ${activeTab === "products" ? "active" : ""}`}
                onClick={() => setActiveTab("products")}
              >
                Products
              </button>
              <button
                className={`tab ${activeTab === "settings" ? "active" : ""}`}
                onClick={() => setActiveTab("settings")}
              >
                Settings
              </button>
            </div>

            {activeTab === "dashboard" && (
              <DashboardTab
                metalPrices={metalPrices}
                handleMetalPriceChange={handleMetalPriceChange}
                handleUpdateMetalPrices={handleUpdateMetalPrices}
                handleRefreshPrices={handleRefreshPrices}
                showSuccess={showSuccess}
                loading={loading}
                stonePrices={stonePrices}
                setShowStoneModal={setShowStoneModal}
                setSelectedStone={setSelectedStone}
              />
            )}

            {activeTab === "products" && (
              <ProductsTab
                products={products}
                loading={loading}
                setSelectedProduct={setSelectedProduct}
              />
            )}

            {selectedProduct && (
              <ProductConfigModal
                product={selectedProduct}
                onClose={() => setSelectedProduct(null)}
                onSave={loadProducts}
                metalPrices={metalPrices}
              />
            )}

            {showStoneModal && (
              <StoneModal
                stone={selectedStone}
                onClose={() => {
                  setShowStoneModal(false);
                  setSelectedStone(null);
                }}
                onSave={loadStonePrices}
              />
            )}
          </div>
        );
      }

      function DashboardTab({
        metalPrices,
        handleMetalPriceChange,
        handleUpdateMetalPrices,
        handleRefreshPrices,
        showSuccess,
        loading,
        stonePrices,
        setShowStoneModal,
        setSelectedStone,
      }) {
        return (
          <>
            <div className="card">
              <h2>METAL PRICES</h2>
              <p
                style={{
                  fontSize: "14px",
                  color: "#6d7175",
                  marginBottom: "16px",
                }}
              >
                Enter the latest metal prices to calculate and update the
                product prices.
              </p>

              {showSuccess && (
                <div className="success-message">
                  âœ“ Metal prices saved successfully! Click "Refresh Prices" to
                  update all products.
                </div>
              )}

              <div className="form-grid">
                <div className="form-group">
                  <label>Gold Price 24K / Gram *</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.gold24kt}
                      onChange={(e) =>
                        handleMetalPriceChange("gold24kt", e.target.value)
                      }
                      placeholder="11869.00"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Gold Price 22K / Gram</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.gold22kt}
                      onChange={(e) =>
                        handleMetalPriceChange("gold22kt", e.target.value)
                      }
                      placeholder="10820"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Gold Price 18K / Gram</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.gold18kt}
                      onChange={(e) =>
                        handleMetalPriceChange("gold18kt", e.target.value)
                      }
                      placeholder="9900"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Gold Price 14K / Gram</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.gold14kt}
                      onChange={(e) =>
                        handleMetalPriceChange("gold14kt", e.target.value)
                      }
                      placeholder="6923.66"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Silver Price / Gram</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.silver}
                      onChange={(e) =>
                        handleMetalPriceChange("silver", e.target.value)
                      }
                      placeholder="158"
                    />
                  </div>
                </div>

                <div className="form-group">
                  <label>Platinum Price / Gram</label>
                  <div className="input-suffix" data-suffix="INR">
                    <input
                      type="number"
                      value={metalPrices.platinum}
                      onChange={(e) =>
                        handleMetalPriceChange("platinum", e.target.value)
                      }
                      placeholder="5500"
                    />
                  </div>
                </div>
              </div>

              <div
                style={{
                  display: "flex",
                  justifyContent: "flex-end",
                  gap: "12px",
                }}
              >
                <button
                  className="btn btn-secondary"
                  onClick={handleUpdateMetalPrices}
                  disabled={loading}
                >
                  ðŸ’¾ Save Metal Prices
                </button>
                <button
                  className="btn btn-primary btn-icon"
                  onClick={handleRefreshPrices}
                  disabled={loading}
                >
                  ðŸ”„ Refresh Prices
                </button>
              </div>
            </div>

            <div className="card">
              <div
                style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                }}
              >
                <h2>STONE PRICES</h2>
                <button
                  className="btn btn-secondary"
                  onClick={() => {
                    setSelectedStone(null);
                    setShowStoneModal(true);
                  }}
                >
                  + Add Stone Pricing
                </button>
              </div>

              <table className="stone-table">
                <thead>
                  <tr>
                    <th>Stone ID</th>
                    <th>Stone Type</th>
                    <th>Slabs</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {stonePrices.map((stone, idx) => (
                    <tr key={idx}>
                      <td>{stone.stone_id}</td>
                      <td>
                        <span className="badge badge-success">
                          {stone.stone_type}
                        </span>
                      </td>
                      <td>
                        {stone.slabs
                          ? `${stone.slabs.length} Slabs`
                          : "0 Slabs"}
                      </td>
                      <td>
                        <button
                          className="link-button"
                          onClick={() => {
                            setSelectedStone(stone);
                            setShowStoneModal(true);
                          }}
                          style={{ marginRight: "12px" }}
                        >
                          Edit
                        </button>
                        <button
                          className="link-button"
                          onClick={async () => {
                            if (
                              confirm(
                                `Delete stone pricing for ${stone.stone_type} (ID: ${stone.stone_id})?`
                              )
                            ) {
                              try {
                                const response = await fetch(
                                  `${API_BASE}/stone-prices/${stone.id}`,
                                  {
                                    method: "DELETE",
                                  }
                                );
                                const data = await response.json();
                                if (data.success) {
                                  alert("Stone pricing deleted successfully!");
                                  loadStonePrices();
                                }
                              } catch (error) {
                                console.error("Error deleting stone:", error);
                                alert("Error deleting stone pricing");
                              }
                            }
                          }}
                          style={{ color: "#d72c0d" }}
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))}
                  {stonePrices.length === 0 && (
                    <tr>
                      <td
                        colSpan="4"
                        style={{ textAlign: "center", color: "#6d7175" }}
                      >
                        No stone pricing configured yet
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </>
        );
      }

      function ProductsTab({ products, loading, setSelectedProduct }) {
        return (
          <div className="card">
            <div
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                marginBottom: "16px",
              }}
            >
              <h2>Products</h2>
              <button className="btn btn-secondary">Search Products</button>
            </div>

            {loading ? (
              <div className="loading">Loading products...</div>
            ) : (
              <table className="product-table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Status</th>
                    <th>Configuration</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {products.map((product, idx) => (
                    <tr key={idx}>
                      <td>
                        <div style={{ fontWeight: 500 }}>{product.title}</div>
                        <div style={{ fontSize: "12px", color: "#6d7175" }}>
                          Vendor: {product.vendor} â€¢ 1 variant
                        </div>
                      </td>
                      <td>
                        <span
                          className={`badge badge-${product.status.toLowerCase()}`}
                        >
                          {product.status}
                        </span>
                      </td>
                      <td>
                        <span
                          className={`badge ${
                            product.configuration?.configured
                              ? "badge-success"
                              : "badge-pending"
                          }`}
                        >
                          {product.configuration?.configured
                            ? "Configured"
                            : "Pending"}
                        </span>
                      </td>
                      <td>
                        <button
                          className="link-button"
                          onClick={() => setSelectedProduct(product)}
                        >
                          Edit
                        </button>
                      </td>
                    </tr>
                  ))}
                  {products.length === 0 && (
                    <tr>
                      <td
                        colSpan="4"
                        style={{ textAlign: "center", color: "#6d7175" }}
                      >
                        No configured products found
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            )}
          </div>
        );
      }

      function ProductConfigModal({ product, onClose, onSave, metalPrices }) {
        const [config, setConfig] = useState({
          metalWeight: product.configuration?.metal_weight || "",
          metalType: product.configuration?.metal_type || "gold22kt",
          makingChargePercent:
            product.configuration?.making_charge_percent || "",
          labourType: product.configuration?.labour_type || "percentage",
          labourValue: product.configuration?.labour_value || "",
          wastageType: product.configuration?.wastage_type || "percentage",
          wastageValue: product.configuration?.wastage_value || "",
          stoneCost: product.configuration?.stone_cost || "",
          taxPercent: product.configuration?.tax_percent || "3",
        });

        const [calculation, setCalculation] = useState(null);

        useEffect(() => {
          if (config.metalWeight && config.metalType) {
            calculatePrice();
          }
        }, [config]);

        const calculatePrice = async () => {
          try {
            const response = await fetch(`${API_BASE}/calculate-price`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(config),
            });

            const data = await response.json();
            if (data.success) {
              setCalculation(data.data);
            }
          } catch (error) {
            console.error("Error calculating price:", error);
          }
        };

        const handleSave = async () => {
          try {
            const response = await fetch(
              `${API_BASE}/products/${product.id}/configure`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(config),
              }
            );

            const data = await response.json();
            if (data.success) {
              alert("Product configured successfully!");
              onSave();
              onClose();
            }
          } catch (error) {
            console.error("Error saving configuration:", error);
            alert("Error saving configuration");
          }
        };

        return (
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <h2>{product.title}</h2>
                <button className="close-btn" onClick={onClose}>
                  Ã—
                </button>
              </div>

              <div className="card" style={{ marginBottom: "16px" }}>
                <h2>CONFIGURE VARIANT</h2>

                <div className="form-grid">
                  <div className="form-group">
                    <label>Metal Type *</label>
                    <select
                      value={config.metalType}
                      onChange={(e) =>
                        setConfig({ ...config, metalType: e.target.value })
                      }
                    >
                      <option value="gold24kt">Gold 24K</option>
                      <option value="gold22kt">Gold 22K</option>
                      <option value="gold18kt">Gold 18K</option>
                      <option value="gold14kt">Gold 14K</option>
                      <option value="platinum">Platinum</option>
                      <option value="silver">Silver</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label>Metal Weight *</label>
                    <div className="input-suffix" data-suffix="Grams">
                      <input
                        type="number"
                        step="0.01"
                        value={config.metalWeight}
                        onChange={(e) =>
                          setConfig({ ...config, metalWeight: e.target.value })
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Making Charge</label>
                    <div className="input-suffix" data-suffix="%">
                      <input
                        type="number"
                        step="0.1"
                        value={config.makingChargePercent}
                        onChange={(e) =>
                          setConfig({
                            ...config,
                            makingChargePercent: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Labour Type</label>
                    <select
                      value={config.labourType}
                      onChange={(e) =>
                        setConfig({ ...config, labourType: e.target.value })
                      }
                    >
                      <option value="percentage">Percentage</option>
                      <option value="fixed">Fixed</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label>Labour Value</label>
                    <div
                      className="input-suffix"
                      data-suffix={
                        config.labourType === "percentage" ? "%" : "INR"
                      }
                    >
                      <input
                        type="number"
                        step="0.1"
                        value={config.labourValue}
                        onChange={(e) =>
                          setConfig({ ...config, labourValue: e.target.value })
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Wastage Type</label>
                    <select
                      value={config.wastageType}
                      onChange={(e) =>
                        setConfig({ ...config, wastageType: e.target.value })
                      }
                    >
                      <option value="percentage">Percentage</option>
                      <option value="fixed">Fixed</option>
                      <option value="weight">Weight</option>
                    </select>
                  </div>

                  <div className="form-group">
                    <label>Wastage Value</label>
                    <div
                      className="input-suffix"
                      data-suffix={
                        config.wastageType === "percentage"
                          ? "%"
                          : config.wastageType === "weight"
                          ? "g"
                          : "INR"
                      }
                    >
                      <input
                        type="number"
                        step="0.1"
                        value={config.wastageValue}
                        onChange={(e) =>
                          setConfig({ ...config, wastageValue: e.target.value })
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Stone Cost</label>
                    <div className="input-suffix" data-suffix="INR">
                      <input
                        type="number"
                        step="0.01"
                        value={config.stoneCost}
                        onChange={(e) =>
                          setConfig({ ...config, stoneCost: e.target.value })
                        }
                      />
                    </div>
                  </div>

                  <div className="form-group">
                    <label>Tax</label>
                    <div className="input-suffix" data-suffix="%">
                      <input
                        type="number"
                        step="0.1"
                        value={config.taxPercent}
                        onChange={(e) =>
                          setConfig({ ...config, taxPercent: e.target.value })
                        }
                      />
                    </div>
                  </div>
                </div>

                {calculation && (
                  <div className="calculation-result">
                    <h3 style={{ marginBottom: "12px", fontSize: "16px" }}>
                      Price Breakdown
                    </h3>
                    <div className="calculation-row">
                      <span>Metal Cost</span>
                      <span>â‚¹{calculation.metalCost.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row">
                      <span>Making Charge</span>
                      <span>â‚¹{calculation.makingCharge.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row">
                      <span>Labour Charge</span>
                      <span>â‚¹{calculation.labourCharge.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row">
                      <span>Wastage Charge</span>
                      <span>â‚¹{calculation.wastageCharge.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row">
                      <span>Stone Cost</span>
                      <span>â‚¹{calculation.stoneCost.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row">
                      <span>Tax Amount ({config.taxPercent}%)</span>
                      <span>â‚¹{calculation.taxAmount.toFixed(2)}</span>
                    </div>
                    <div className="calculation-row total">
                      <span>Final Product Price</span>
                      <span>â‚¹{calculation.finalPrice.toFixed(2)}</span>
                    </div>
                  </div>
                )}
              </div>

              <div
                style={{
                  display: "flex",
                  justifyContent: "flex-end",
                  gap: "12px",
                }}
              >
                <button className="btn btn-secondary" onClick={onClose}>
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={handleSave}>
                  Done
                </button>
              </div>
            </div>
          </div>
        );
      }

      function StoneModal({ stone, onClose, onSave }) {
        const [stoneData, setStoneData] = useState({
          stoneId: stone?.stone_id || "",
          stoneType: stone?.stone_type || "Diamond",
          title: stone?.title || "",
          clarity: stone?.clarity || "",
          color: stone?.color || "",
          shape: stone?.shape || "",
          slabs: stone?.slabs || [
            { fromWeight: "", toWeight: "", pricePerCarat: "" },
          ],
        });

        const isEditing = !!stone;

        const addSlab = () => {
          setStoneData({
            ...stoneData,
            slabs: [
              ...stoneData.slabs,
              { fromWeight: "", toWeight: "", pricePerCarat: "" },
            ],
          });
        };

        const updateSlab = (index, field, value) => {
          const newSlabs = [...stoneData.slabs];
          newSlabs[index][field] = value;
          setStoneData({ ...stoneData, slabs: newSlabs });
        };

        const handleSave = async () => {
          try {
            // Include the stone ID if editing
            const dataToSave = {
              ...stoneData,
              ...(stone?.id && { id: stone.id }), // Add Shopify metaobject ID if editing
            };

            const response = await fetch(`${API_BASE}/stone-prices`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(dataToSave),
            });

            const data = await response.json();
            if (data.success) {
              alert(
                isEditing
                  ? "Stone pricing updated successfully!"
                  : "Stone pricing created successfully!"
              );
              onSave();
              onClose();
            }
          } catch (error) {
            console.error("Error saving stone pricing:", error);
            alert("Error saving stone pricing");
          }
        };

        return (
          <div className="modal">
            <div className="modal-content">
              <div className="modal-header">
                <h2>
                  {isEditing ? "Edit Stone Pricing" : "Add Stone Pricing"}
                </h2>
                <button className="close-btn" onClick={onClose}>
                  Ã—
                </button>
              </div>

              <div className="form-grid">
                <div className="form-group">
                  <label>Stone ID *</label>
                  <input
                    type="text"
                    value={stoneData.stoneId}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, stoneId: e.target.value })
                    }
                    placeholder="VVS 1"
                  />
                </div>

                <div className="form-group">
                  <label>Title *</label>
                  <input
                    type="text"
                    value={stoneData.title}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, title: e.target.value })
                    }
                    placeholder="DIAMOND"
                  />
                </div>

                <div className="form-group">
                  <label>Stone Type *</label>
                  <input
                    type="text"
                    value={stoneData.stoneType}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, stoneType: e.target.value })
                    }
                    placeholder="Diamond"
                  />
                </div>

                <div className="form-group">
                  <label>Clarity</label>
                  <input
                    type="text"
                    value={stoneData.clarity}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, clarity: e.target.value })
                    }
                  />
                </div>

                <div className="form-group">
                  <label>Color</label>
                  <input
                    type="text"
                    value={stoneData.color}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, color: e.target.value })
                    }
                  />
                </div>

                <div className="form-group">
                  <label>Shape</label>
                  <input
                    type="text"
                    value={stoneData.shape}
                    onChange={(e) =>
                      setStoneData({ ...stoneData, shape: e.target.value })
                    }
                  />
                </div>
              </div>

              <div style={{ marginTop: "24px" }}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    marginBottom: "12px",
                  }}
                >
                  <h3>PRICING SLABS</h3>
                  <button className="btn btn-secondary" onClick={addSlab}>
                    + Add Slab
                  </button>
                </div>

                <table className="stone-table">
                  <thead>
                    <tr>
                      <th>Srl. No</th>
                      <th>From Weight</th>
                      <th>To Weight</th>
                      <th>Price per Carat</th>
                    </tr>
                  </thead>
                  <tbody>
                    {stoneData.slabs.map((slab, idx) => (
                      <tr key={idx}>
                        <td>{idx + 1}</td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            value={slab.fromWeight}
                            onChange={(e) =>
                              updateSlab(idx, "fromWeight", e.target.value)
                            }
                            style={{ width: "100%", padding: "6px" }}
                          />
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            value={slab.toWeight}
                            onChange={(e) =>
                              updateSlab(idx, "toWeight", e.target.value)
                            }
                            style={{ width: "100%", padding: "6px" }}
                          />
                        </td>
                        <td>
                          <input
                            type="number"
                            step="0.01"
                            value={slab.pricePerCarat}
                            onChange={(e) =>
                              updateSlab(idx, "pricePerCarat", e.target.value)
                            }
                            style={{ width: "100%", padding: "6px" }}
                            placeholder="INR"
                          />
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div
                style={{
                  display: "flex",
                  justifyContent: "flex-end",
                  gap: "12px",
                  marginTop: "24px",
                }}
              >
                <button className="btn btn-secondary" onClick={onClose}>
                  Cancel
                </button>
                <button className="btn btn-primary" onClick={handleSave}>
                  Save
                </button>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>